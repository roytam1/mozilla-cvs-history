DEPTH		= ../../../../..
NS_DEPTH	= ../../../..
srcdir		= @srcdir@
ldaptopsrcdir	= @top_srcdir@

include ../../build/autoconf.mk

RM		= rm -f
SED		= sed

SRCS		= abandon.c \
		  add.c \
		  bind.c \
		  cache.c \
		  charray.c \
		  charset.c \
		  compare.c \
		  compat.c \
		  control.c \
		  countvalues.c \
		  delete.c \
		  disptmpl.c \
		  dsparse.c \
		  error.c \
		  extendop.c \
		  free.c \
		  freevalues.c \
		  friendly.c \
		  getattr.c \
		  getdn.c \
		  getdxbyname.c \
		  getentry.c \
		  getfilter.c \
		  getoption.c \
		  getvalues.c \
		  memcache.c \
		  message.c \
		  modify.c \
		  open.c \
		  os-ip.c \
		  proxyauthctrl.c \
		  psearch.c \
		  referral.c \
		  regex.c \
		  rename.c \
		  request.c \
		  reslist.c \
		  result.c \
		  saslbind.c \
		  sbind.c \
		  search.c \
		  setoption.c \
		  sort.c \
		  sortctrl.c \
		  srchpref.c \
		  tmplout.c \
		  ufn.c \
		  unbind.c \
		  unescape.c \
		  url.c \
		  utf8.c \
		  vlistctrl.c

ifeq ($(OS_ARCH),WINNT)
LBER_SRCS	= \
		decode.c \
		encode.c \
		io.c \
		bprint.c \
		$(NULL)

SRCS		+= mozock.c \
		$(addprefix ../liblber/,$(LBER_SRCS))
endif

REALOBJS	= $(SRCS:.c=.$(OBJ_SUFFIX))

#OBJS		= $(REALOBJS) versiont.o
OBJS		= $(REALOBJS)

HDIR		= $(ldaptopsrcdir)/include
HDIR2		= ../../include

CFLAGS		= $(INCLUDES) $(DEFINES)

ifeq ($(OS_ARCH),WINNT)
RES		= nsldap.res
RESNAME		= $(srcdir)/../msdos/winsock/nsldap.rc
LIBRARY_NAME	= nsldap32v40
else
LIBRARY_NAME	= ldap40
endif

#
# DEFS are included in CFLAGS
#
DEFS		= $(PLATFORMCFLAGS) $(LDAP_DEBUG) $(KERBEROS) $(AFSKERBEROS) \
		  $(UOFM) $(UOFA) $(NO_USERINTERFACE) $(CLDAP) $(NO_CACHE) \
		  $(LDAP_REFERRALS) $(LDAP_DNS) $(STR_TRANSLATION) \
		  $(LIBLDAP_CHARSETS) $(LIBLDAP_DEF_CHARSET) \
		  $(SLAPD_BACKENDS) $(LDBMBACKEND) $(LDBMINCLUDE) $(PHONETIC) \
		  $(LDAP_SSLIO_HOOKS)

include $(NSPR_TREE)/config/rules.mk

LOCAL_INCLUDES  = -I$(PUBLIC)/nspr
INCLUDES	+= -I$(HDIR) -I$(HDIR2) $(KRBINCLUDEFLAG)
DEFINES		+= $(DEFS) -DFILTERFILE=./ldapfilter.conf \
		   -DTEMPLATEFILE=./ldaptemplates.conf \
		   -DNDEBUG -UMOZILLA_CLIENT

ifeq ($(OS_ARCH),WINNT)
DEFINES		+= /D_WINDOWS /DWINSOCK \
	/D_WIN32 /DWIN32_KERNEL_THREADS \
	/DNO_USERINTERFACE /DLDAP_SSLIO_HOOKS 
EXTRA_LIBS += rpcrt4.lib winmm.lib wsock32.lib oldnames.lib kernel32.lib user32.lib
DLL_LIBS += /DEF:$(srcdir)/../msdos/winsock/nsldap3240.def \
	/implib:$(LIBRARY_NAME).$(LIB_SUFFIX) \
	/nodefaultlib
ifdef BUILD_OPT
EXTRA_LIBS += msvcrt.lib
else
EXTRA_LIBS += msvcrtd.lib
endif
endif

ifeq ($(OS_ARCH), OS2)
INCLUDES	+=  -I$(DIST)/include
EXTRA_LIBS  += $(DIST)/lib/lber40.lib
endif

# So we actually get the definition of hostent_data....
ifeq ($(OS_ARCH),AIX)
DEFINES               += -D_THREAD_SAFE
DSO_LDOPTS      += -lm -lc_r -L../liblber -llber40
endif

ifneq (,$(filter BeOS Linux,$(OS_ARCH)))
DSO_LDOPTS	+= -L../liblber -llber40
endif

ifneq (,$(filter OpenVMS Darwin,$(OS_ARCH)))
EXTRA_LIBS      += -L../liblber -llber40
endif

GARBAGE		+= $(ETCDIR)/ldapfriendly $(ETCDIR)/ldapfilter.conf \
		   $(ETCDIR)/ldaptemplates.conf $(ETCDIR)/ldapsearchprefs.conf

ifeq ($(OS_ARCH),WINNT)
PLATFORMCFLAGS	= -DNEEDPROTOS
else
PLATFORMCFLAGS	= -DUSE_WAITPID -DNEEDPROTOS
endif
PLATFORMLIBS	=
THREADS		=
THREADSLIB	=

ETCFILES	= ldapfilter.conf \
		  ldapfriendly \
		  ldapsearchprefs.conf \
		  ldaptemplates.conf \
		  $(NULL)

ETCDIR		= $(DIST)/etc

#
# if you want things to run in a different directory from where they
# are installed, set this accordingly (this path gets compiled into a
# few binaries). otherwise, leave it alone.
#
RUNTIMEETCDIR	= $(ETCDIR)

#
# To build slapd (the stand-alone ldap daemon), uncomment the MAKESLAPD
# line and select the SLAPD_BACKENDS you want to use. If you enable the
# LDBM backend, also select one of the LDBM backends.
#
MAKESLAPD	= yes
SLAPD_BACKENDS	= -DLDAP_LDBM -DLDAP_SHELL -DLDAP_PASSWD
LDBMBACKEND	= -DLDBM_USE_NDBM

#
# uncomment this line to enable debugging code (a good idea)
#
ifndef BUILD_OPT
LDAP_DEBUG	= -DLDAP_DEBUG
endif

#
# uncomment this line to enable support for LDAP referrals in libldap
#
LDAP_REFERRALS		= -DLDAP_REFERRALS

#
# uncomment this line to enable support for SSL I/O in libldap
#
LDAP_SSLIO_HOOKS	= -DLDAP_SSLIO_HOOKS

###########################################################################

versiont.c:	Makefile.client Version.c
	@$(RM) $@
	@(u="$${USER-root}" v="$(shell cat ../../build/version)" d="$(shell pwd)" \
	h="$(shell hostname)" t="$(shell date)"; $(SED) -e "s|%WHEN%|$${t}|" \
	-e "s|%WHOANDWHERE%|$${u}@$${h}:$${d}|" \
	-e "s|%VERSION%|$${v}|" \
	< Version.c > $@)

ifeq ($(OS_ARCH),OS2)
install:: $(TARGETS)
	$(INSTALL) -m 444 $(TARGETS) $(DIST)/lib
ifdef SHARED_LIBRARY
	$(INSTALL) -m 444 $(SHARED_LIBRARY) $(DIST)/bin
endif

else  # !os2

install::	$(LIBRARY) $(SHARED_LIBRARY) $(IMPORT_LIBRARY)
	$(INSTALL) -m 444 $(LIBRARY) $(DIST)/lib
ifdef MKSHLIB
	$(INSTALL) -m 555 $(SHARED_LIBRARY) $(DIST)/lib
	$(INSTALL) -m 555 $(SHARED_LIBRARY) $(DIST)/bin
ifdef IMPORT_LIBRARY
	$(INSTALL) -m 444 $(IMPORT_LIBRARY) $(DIST)/lib
endif
endif

endif # os2

# XXX currently we don't install any of these config files; what to do?
#
#	$(INSTALL) $(INSTALLFLAGS) -m 644 $(ETCFILES) $(ETCDIR)
