#
# The contents of this file are subject to the Netscape Public
# License Version 1.1 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of
# the License at http://www.mozilla.org/NPL/
#
# Software distributed under the License is distributed on an "AS
# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
# implied. See the License for the specific language governing
# rights and limitations under the License.
#
# The Original Code is mozilla.org code.
#
# The Initial Developer of the Original Code is Netscape
# Communications Corporation.  Portions created by Netscape are
# Copyright (C) 1998 Netscape Communications Corporation. All
# Rights Reserved.
#
# Contributor(s): 
#

DEPTH			= ../../..
topsrcdir		= @top_srcdir@
srcdir			= @srcdir@
VPATH			= @srcdir@

include $(DEPTH)/config/autoconf.mk

DIRS			:= public

PROGRAM			:= viewer$(BIN_SUFFIX)

CPPSRCS			= \
			$(TOOLKIT_CPPSRCS) \
			nsBaseDialog.cpp \
			nsFindDialog.cpp \
			nsXPBaseWindow.cpp \
			nsTableInspectorDialog.cpp \
			nsImageInspectorDialog.cpp \
			nsPrintSetupDialog.cpp \
			nsBrowserWindow.cpp \
			nsEditorMode.cpp \
			nsSetupRegistry.cpp \
			nsThrobber.cpp \
			nsViewerApp.cpp \
			nsWebCrawler.cpp \
			nsWebBrowserChrome.cpp \
			$(NULL)

EXPORT_RESOURCE_SAMPLES	:= \
			$(wildcard $(srcdir)/samples/test*.html) \
			$(wildcard $(srcdir)/samples/toolbarTest*.xul) \
			$(wildcard $(srcdir)/samples/treeTest*.xul) \
			$(wildcard $(srcdir)/samples/treeTest*.css) \
			$(wildcard $(srcdir)/samples/slider*.xul) \
			$(wildcard $(srcdir)/samples/scrollbar*.xul) \
			$(srcdir)/resources/find.html \
			$(srcdir)/resources/printsetup.html \
			$(srcdir)/resources/image_props.html \
			$(srcdir)/samples/aform.css \
			$(srcdir)/samples/bform.css \
			$(srcdir)/samples/cform.css \
			$(srcdir)/samples/demoform.css \
			$(srcdir)/samples/mozform.css \
			$(srcdir)/samples/xulTest.css \
			$(srcdir)/samples/Anieyes.gif \
			$(srcdir)/samples/gear1.gif \
			$(srcdir)/samples/rock_gra.gif \
			$(srcdir)/samples/beeptest.html \
			$(srcdir)/samples/soundtest.html \
			$(srcdir)/samples/bg.jpg \
			$(srcdir)/samples/raptor.jpg \
			$(srcdir)/samples/test.wav \
			$(srcdir)/samples/checkboxTest.xul \
			$(NULL)

EXPORT_RESOURCE_THROBBER := $(wildcard $(srcdir)/throbber/anim*.gif)

ifeq (,$(filter beos os2 photon mac,$(MOZ_WIDGET_TOOLKIT)))
DIRS			+= unix
UNIX_VIEWER_TK_LIBS	= unix/$(MOZ_WIDGET_TOOLKIT)/libviewer_$(MOZ_WIDGET_TOOLKIT)_s.a
else
ifeq ($(MOZ_WIDGET_TOOLKIT),beos)
BEOS_PROGRAM_RESOURCE	= $(srcdir)/viewer-beos.rsrc
TOOLKIT_CPPSRCS		= nsBeOSMain.cpp
endif
ifeq ($(MOZ_WIDGET_TOOLKIT),os2)
TOOLKIT_CPPSRCS		= nsOS2Main.cpp
endif
ifeq ($(MOZ_WIDGET_TOOLKIT),photon)
TOOLKIT_CPPSRCS		= nsPhMain.cpp nsPhMenu.cpp
endif
ifeq ($(MOZ_WIDGET_TOOLKIT),mac)
TOOLKIT_CPPSRCS		= nsMacMain.cpp
endif
endif

ifeq ($(MOZ_WIDGET_TOOLKIT),gtk)
GTK_GLUE		= -lgtksuperwin
endif

ifdef MOZ_OJI
JSJ_LIB			= -ljsj
endif

XP_DIST_LIBS		= \
			-lgkgfx \
			$(MOZ_JS_LIBS) \
			$(XPCOM_LIBS) \
			$(JSJ_LIB) \
			$(NULL)

XP_NS_UNDERBAR_CRAP	= \
			$(MOZ_WIDGET_SUPPORT_LIBS) \
			$(NULL)

XP_LIBS			= \
			$(XP_NS_UNDERBAR_CRAP) \
			$(XP_DIST_LIBS) \
			$(LOST_SYM_LIBS) \
			$(NSPR_LIBS) \
			$(NULL)

ifdef MOZ_FULLCIRCLE
XP_LIBS			+= $(FULLCIRCLE_LIBS)
endif

ifeq ($(MOZ_WIDGET_TOOLKIT),os2)
XP_LIBS			+= -llibxpfelocation_s
else
XP_LIBS			+= -lxpfelocation_s
endif

LIBS			= \
			$(UNIX_VIEWER_TK_LIBS) \
			$(GTK_GLUE) \
			$(XP_LIBS) \
			$(TK_LIBS) \
			$(NULL)

MOTIF_LIBS		= -lviewer_motif_s $(XP_LIBS) $(MOZ_MOTIF_LDFLAGS)
QT_LIBS			= -lviewer_qt_s $(XP_LIBS) $(MOZ_QT_LDFLAGS)
XLIB_LIBS		= -lviewer_xlib_s $(XP_LIBS) $(MOZ_XLIB_LDFLAGS)
GTK_LIBS		= -lviewer_gtk_s -lgtksuperwin $(XP_LIBS) $(MOZ_GTK_LDFLAGS)

ifeq ($(MOZ_OS2_TOOLS),VACPP)
XP_DIST_DEP_LIBS    := $(patsubst -l%,$(DIST)/lib/%.lib,$(XP_DIST_LIBS))
else
XP_DIST_DEP_LIBS	:= $(filter-out -L$(DIST)/bin -L$(DIST)/lib, $(XP_DIST_LIBS))
XP_DIST_DEP_LIBS	:= $(addprefix $(DIST)/,$(patsubst -l%,bin/lib%$(DLL_SUFFIX),$(XP_DIST_DEP_LIBS:-l%_s=lib/lib%_s.a)))
endif

EXTRA_DEPS		= \
			$(XP_DIST_DEP_LIBS) \
			$(UNIX_VIEWER_TK_LIBS) \
			$(XP_NS_UNDERBAR_CRAP) \
			$(NULL)

include $(topsrcdir)/config/config.mk

ifeq ($(OS_ARCH)$(OS_TEST),NetBSDarm32)
NO_LD_ARCHIVE_FLAGS	:= 1
endif

ifdef NO_LD_ARCHIVE_FLAGS
LOST_SYM_LIBS		= -lxpcomds_s -lxpcomio_s -lxptinfo -lmozreg_s
endif

# Force a build thru DIRS so that dependencies are updated properly
install::
	+$(LOOP_OVER_DIRS)

include $(topsrcdir)/config/rules.mk

ifeq ($(OS_ARCH),Rhapsody)
INCLUDES		+= -I$(topsrcdir)/widget/src/mac
endif

CXXFLAGS		+= $(MOZ_TOOLKIT_REGISTRY_CFLAGS)

GARBAGE			+= $(PROGRAM)_gtk $(PROGRAM)_motif $(PROGRAM)_qt $(PROGRAM)_xlib

install:: $(PROGRAM) $(srcdir)/mozilla-viewer.sh
	$(INSTALL) $(EXPORT_RESOURCE_SAMPLES) $(DIST)/bin/res/samples
	$(INSTALL) $(EXPORT_RESOURCE_THROBBER) $(DIST)/bin/res/throbber
	$(INSTALL) $(srcdir)/resources/viewer.properties $(DIST)/bin/res
	$(INSTALL) $(srcdir)/mozilla-viewer.sh $(DIST)/bin

unix/gtk/libviewer_gtk_s.a:
	@$(MAKE) -C $(@D) $(@F)

unix/motif/libviewer_motif_s.a:
	@$(MAKE) -C $(@D) $(@F)

unix/qt/libviewer_qt_s.a:
	@$(MAKE) -C $(@D) $(@F)

unix/xlib/libviewer_xlib_s.a:
	@$(MAKE) -C $(@D) $(@F)

$(PROGRAM)_gtk: $(PROGOBJS) $(EXTRA_DEPS) Makefile Makefile.in unix/gtk/libviewer_gtk_s.a
	$(CCC) $(CXXFLAGS) -o $@ $(PROGOBJS) $(LDFLAGS) $(LIBS_DIR) $(GTK_LIBS) $(OS_LIBS)
	$(MOZ_POST_PROGRAM_COMMAND) $@

$(PROGRAM)_motif: $(PROGOBJS) $(EXTRA_DEPS) Makefile Makefile.in unix/motif/libviewer_motif_s.a
	$(CCC) $(CXXFLAGS) -o $@ $(PROGOBJS) $(LDFLAGS) $(LIBS_DIR) $(MOTIF_LIBS) $(OS_LIBS)
	$(MOZ_POST_PROGRAM_COMMAND) $@

$(PROGRAM)_qt: $(PROGOBJS) $(EXTRA_DEPS) Makefile Makefile.in unix/qt/libviewer_qt_s.a
	$(CCC) $(CXXFLAGS) -o $@ $(PROGOBJS) $(LDFLAGS) $(LIBS_DIR) $(QT_LIBS) $(OS_LIBS)
	$(MOZ_POST_PROGRAM_COMMAND) $@

$(PROGRAM)_xlib: $(PROGOBJS) $(EXTRA_DEPS) Makefile Makefile.in unix/xlib/libviewer_xlib_s.a
	$(CCC) $(CXXFLAGS) -o $@ $(PROGOBJS) $(LDFLAGS) $(LIBS_DIR) $(XLIB_LIBS) $(OS_LIBS)
	$(MOZ_POST_PROGRAM_COMMAND) $@

ifdef MOZ_ENABLE_GTK
install:: $(PROGRAM)_gtk
	$(INSTALL) -m 555 $< $(DIST)/bin
endif

ifdef MOZ_ENABLE_MOTIF
install:: $(PROGRAM)_motif
	$(INSTALL) -m 555 $< $(DIST)/bin
endif

ifdef MOZ_ENABLE_QT
install:: $(PROGRAM)_qt
	$(INSTALL) -m 555 $< $(DIST)/bin
endif

ifdef MOZ_ENABLE_XLIB
install:: $(PROGRAM)_xlib
	$(INSTALL) -m 555 $< $(DIST)/bin
endif

