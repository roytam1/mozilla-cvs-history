<?xml version="1.0" encoding="UTF-8"?>
<!--
   - ***** BEGIN LICENSE BLOCK *****
   - Version: MPL 1.1/GPL 2.0/LGPL 2.1
   -
   - The contents of this file are subject to the Mozilla Public License Version
   - 1.1 (the "License"); you may not use this file except in compliance with
   - the License. You may obtain a copy of the License at
   - http://www.mozilla.org/MPL/
   -
   - Software distributed under the License is distributed on an "AS IS" basis,
   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
   - for the specific language governing rights and limitations under the
   - License.
   -
   - The Original Code is Calendar view code.
   -
   - The Initial Developer of the Original Code is
   -   Joey Minta <jminta@gmail.com>
   - Portions created by the Initial Developer are Copyright (C) 2005
   - the Initial Developer. All Rights Reserved.
   -
   - Contributor(s):
   -   Michael BÃ¼ttner <michael.buettner@sun.com>
   -   Philipp Kewisch <mozilla@kewis.ch>
   -
   - Alternatively, the contents of this file may be used under the terms of
   - either the GNU General Public License Version 2 or later (the "GPL"), or
   - the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
   - in which case the provisions of the GPL or the LGPL are applicable instead
   - of those above. If you wish to allow use of your version of this file only
   - under the terms of either the GPL or the LGPL, and not to allow others to
   - use your version of this file under the terms of the MPL, indicate your
   - decision by deleting the provisions above and replace them with the notice
   - and other provisions required by the GPL or the LGPL. If you do not delete
   - the provisions above, a recipient may use your version of this file under
   - the terms of any one of the MPL, the GPL or the LGPL.
   -
   - ***** END LICENSE BLOCK *****
-->

<!-- Note that this file depends on helper functions in calUtils.js-->

<bindings id="calendar-core-view-bindings"
    xmlns="http://www.mozilla.org/xbl"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
    xmlns:xbl="http://www.mozilla.org/xbl">

  <binding id="calendar-editable-item">
    <content>
      <xul:vbox flex="1">
        <xul:hbox>
          <xul:image class="calendar-event-box-shadow-left"/>
          <xul:box anonid="event-container" flex="1">
            <xul:box class="calendar-event-selection" orient="horizontal" flex="1">
              <xul:stack anonid="eventbox"
                         class="calendar-event-box-container"      
                         flex="1">
                <xul:hbox class="calendar-event-details">
                  <xul:vbox align="left"
                            flex="1"
                            xbl:inherits="context">
                    <xul:label anonid="event-name"
                               crop="end"
                               flex="1"
                               style="margin: 0;"/>
                    <xul:textbox anonid="event-name-textbox"
                                 class="plain"
                                 crop="end"
                                 hidden="true"
                                 style="background: transparent !important;"
                                 wrap="true"/>
                    <xul:spacer flex="1"/>
                  </xul:vbox>
                  <xul:vbox pack="center">
                    <xul:image anonid="alarm-image"
                               class="alarm-image"
                               xbl:inherits="flashing"
                               hidden="true"/>
                  </xul:vbox>
                </xul:hbox>
                <xul:image anonid="gradient"
                           class="calendar-event-box-gradient"
                           hidden="true" height="1px"/>
              </xul:stack>
            </xul:box>
            <xul:calendar-category-box anonid="category-box"/>
          </xul:box>
          <xul:image class="calendar-event-box-shadow-right"/>
        </xul:hbox>
        <xul:box orient="horizontal">
          <xul:image class="calendar-event-box-shadow-edge-left"/>
          <xul:image class="calendar-event-box-shadow-bottom" flex="1"/>
          <xul:image class="calendar-event-box-shadow-edge-right"/>
        </xul:box>
      </xul:vbox>
    </content>

    <implementation>
      <constructor><![CDATA[
         var gradient = document.getAnonymousElementByAttribute(this,
                                                                "anonid",
                                                                "gradient");
         var container = document.getAnonymousElementByAttribute(this,
                                                                 "anonid",
                                                                 "event-container");
         if (gradient) {
           gradient.removeAttribute("hidden");
         }

         this.setAttribute("tooltip", "itemTooltip");
         container.setAttribute("class", "calendar-item");

         var self = this;
         this.eventNameInput.onblur = function alldayItemBlur() { self.stopEditing(true); };
         this.eventNameInput.onkeypress = function alldayItemKeyPress(event) {
             // save on enter
             if (event.keyCode == 13)
                 self.stopEditing(true);
             // abort on escape
             else if (event.keyCode == 27)
                 self.stopEditing(false);
         };
      ]]></constructor>

      <field name="mOccurrence">null</field>
      <field name="mSelected">false</field>
      <field name="mCalendarView">null</field>

      <property name="selected">
        <getter><![CDATA[
          return this.mSelected;
        ]]></getter>
        <setter><![CDATA[
          if (val && !this.mSelected) {
              this.mSelected = true;
              this.setAttribute("selected", "true");
          } else if (!val && this.mSelected) {
              this.mSelected = false;
              this.removeAttribute("selected");
          }
          return val;
        ]]></setter>
      </property>
      <property name="calendarView">
        <getter><![CDATA[
          return this.mCalendarView;
        ]]></getter>
        <setter><![CDATA[
          this.mCalendarView = val;
          return val;
        ]]></setter>
      </property>

      <property name="occurrence">
        <getter><![CDATA[
          return this.mOccurrence;
        ]]></getter>
        <setter><![CDATA[
          this.mOccurrence = val;
          this.setEditableLabel();
          this.setCSSClasses();
          return val;
        ]]></setter>
      </property>

      <property name="eventNameLabel" readonly="true"
        onget="return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name');"/>
      <property name="eventNameTextbox" readonly="true"
        onget="return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox');"/>
      <property name="eventNameInput" readonly="true"
        onget="return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox').inputField;"/>
      <method name="setEditableLabel">
        <body><![CDATA[
          var evl = this.eventNameLabel;
          var item = this.mOccurrence;


          if (item.title && item.title != "") {
            evl.value = item.title;
          } else {
            evl.value = calGetString("calendar", "eventUntitled")
          }
        ]]></body>
      </method>

      <method name="setCSSClasses">
        <body><![CDATA[
          var container = document.getAnonymousElementByAttribute(this,
                                                                  "anonid",
                                                                  "event-container");
          var item = this.mOccurrence
          container.setAttribute("item-calendar", item.calendar.uri.spec);

          var categoriesSelectorList = "";
          if (item.getProperty("CATEGORIES") != null) {
            var categoriesList = item.getProperty("CATEGORIES").split(",");
            for (var i = 0; i < categoriesList.length; i++ ) {
              // Remove illegal chars.
              categoriesList[i] = categoriesList[i].replace(' ','_');
              categoriesList[i] = categoriesList[i].toLowerCase();
            }
            categoriesSelectorList = categoriesList.join(" ");
          }

          var box = document.
              getAnonymousElementByAttribute(this,"anonid","category-box");
          if (box) {
              box.categories = categoriesSelectorList;
              box = document.
                  getAnonymousElementByAttribute(this,"anonid","eventbox");
              if (box) {
                if (categoriesSelectorList.length > 0) {
                  box.setAttribute("has-category","true");
                } else {
                  box.removeAttribute("has-category");
                }
              }
          }

          var alarmImage = document.getAnonymousElementByAttribute(this, "anonid", "alarm-image");
          if (item.alarmOffset && getPrefSafe("calendar.alarms.indicator.show", true)) {
              alarmImage.removeAttribute("hidden");
          }
        ]]></body>
      </method>

      <method name="startEditing">
        <body><![CDATA[
          this.editingTimer = null;
          this.mOriginalTextLabel = this.mOccurrence.title;

          this.eventNameLabel.setAttribute("hidden", "true");

          this.mEditing = true;

          this.eventNameTextbox.value = this.mOriginalTextLabel;
          this.eventNameTextbox.removeAttribute("hidden");
          if (this.calendarView)
              this.calendarView.activeInPlaceEdit = true;
          this.eventNameInput.focus();
          this.eventNameInput.select();
        ]]></body>
      </method>
      <method name="select">
        <parameter name="event"/>
        <body><![CDATA[
            var items;
            if (event.ctrlKey || event.metaKey) {
                items = this.calendarView.mSelectedItems;
                items.push(this.mOccurrence);
            } else {
                items = [this.mOccurrence];
            }
            this.calendarView.setSelectedItems(items.length, items);
        ]]></body>
      </method>
      <method name="stopEditing">
        <parameter name="saveChanges"/>
        <body><![CDATA[
          if (!this.mEditing)
            return;

          this.mEditing = false;

          if (this.calendarView)
            this.calendarView.activeInPlaceEdit = false;

          if (saveChanges && (this.eventNameTextbox.value != this.mOriginalTextLabel)) {
              this.calendarView.controller.modifyOccurrence(this.mOccurrence, 
                                                            null, null,
                                                            this.eventNameTextbox.value);

              // Note that as soon as we do the modifyItem, this element ceases to exist,
              // so don't bother trying to modify anything further here! ('this' exists,
              // because it's being kept alive, but our child content etc. is all gone)
              return;
          }

          this.eventNameTextbox.setAttribute("hidden", "true");
          this.eventNameLabel.removeAttribute("hidden");
          return;
        ]]></body>
      </method>
    </implementation>

    <handlers>
      <handler event="contextmenu" phase="capturing"><![CDATA[
       // If the middle/right button was used for click just select the item.
        this.select(event);
      ]]></handler>
      <handler event="click" button="0"><![CDATA[
        if (this.mEditing) {
            return;
        }

        // If the left button was used and the item is already selected start
        // the 'single click edit' timeout. Otherwise select the item too.
        // Also, check if the calendar is readOnly.
        if (this.selected && !this.mOccurrence.calendar.readOnly) {
            var self = this;
            if (this.editingTimer) {
                clearTimeout(this.editingTimer);
            }
            this.editingTimer = setTimeout(function alldayTimeout() { self.startEditing(); }, 350);
        } else {
            this.select(event);
            event.stopPropagation();
        }
      ]]></handler>

      <handler event="dblclick" button="0"><![CDATA[
        event.stopPropagation();

        // stop 'single click edit' timeout (if started)
        if (this.editingTimer) {
            clearTimeout(this.editingTimer);
            this.editingTimer = null;
        }

        if (this.calendarView.controller) {
            var item = (event.ctrlKey) ? this.mOccurrence.parentItem : this.mOccurrence;
            this.calendarView.controller.modifyOccurrence(item);
        }
      ]]></handler>
      <handler event="mouseover"><![CDATA[
        if (this.calendarView && this.calendarView.controller) {
            event.stopPropagation();
            onMouseOverItem(event);
        }
      ]]></handler>
      <handler event="draggesture"><![CDATA[
        var dragService = Components.classes["@mozilla.org/widget/dragservice;1"].
                          getService(Components.interfaces.nsIDragService);
        var transfer = Components.classes["@mozilla.org/widget/transferable;1"].
                       createInstance(Components.interfaces.nsITransferable);
        transfer.addDataFlavor("text/calendar");

        var item = this.mOccurrence;
        if (item.calendar.readOnly)
            return;
        if (!item.startDate || !item.startDate.isDate)
            return;
        if (!this.selected)
            this.select(event);

        var flavourProvider = {
            QueryInterface: function(aIID) {
                ensureIID(
                    [ Components.interfaces.nsIFlavorDataProvider,
                      Components.interfaces.nsISupports], aIID);
                return this;
            },
            item: item,

            getFlavorData: function(aInTransferable, aInFlavor, aOutData, aOutDataLen) {
                if ((aInFlavor == "application/vnd.x-moz-cal-event") ||
                    (aInFlavor == "application/vnd.x-moz-cal-task")) {
                    aOutData.value = this.item;
                    aOutDataLen.value = 1;
                } else {
                    ASSERT(false, "error:"+aInFlavor);
                }
            }
        };

        if (isEvent(item)) {
          transfer.addDataFlavor("application/vnd.x-moz-cal-event");
          transfer.setTransferData("application/vnd.x-moz-cal-event", flavourProvider, 0);
        } else if (isToDo(item)) {
          transfer.addDataFlavor("application/vnd.x-moz-cal-task");
          transfer.setTransferData("application/vnd.x-moz-cal-task", flavourProvider, 0);
        }

        // Also set some normal data-types, in case we drag into another app
        var serializer = Components.classes["@mozilla.org/calendar/ics-serializer;1"].
                                    createInstance(Components.interfaces.calIIcsSerializer);
        serializer.addItems([item], 1);

        var supportsString = Components.classes["@mozilla.org/supports-string;1"].
                             createInstance(Components.interfaces.nsISupportsString);
        supportsString.data = serializer.serializeToString();
        transfer.setTransferData("text/calendar", supportsString, supportsString.data.length*2);
        transfer.setTransferData("text/unicode", supportsString, supportsString.data.length*2);

        var action = dragService.DRAGDROP_ACTION_MOVE;
        var supArray = Components.classes["@mozilla.org/supports-array;1"].
                       createInstance(Components.interfaces.nsISupportsArray);
        supArray.AppendElement(transfer);

        dragService.invokeDragSession(this, supArray, null, action);
      ]]></handler>
    </handlers>
  </binding>

  <binding id="calendar-category-box">
    <content>
      <xul:vbox anonid="category-box" hidden="true" class="calendar-item calendar-event-selection">
        <xul:hbox flex="1">
          <xul:image class="calendar-category-box-gradient" height="1"/>
        </xul:hbox>
        <xul:hbox height="1"/>
      </xul:vbox>
    </content>
    <implementation>
      <property name="categories">
        <setter><![CDATA[
          var box = document.getAnonymousElementByAttribute(this,
                                                            "anonid",
                                                            "category-box");
          box.setAttribute("item-category", val);
          if (val.length > 0) {
            box.removeAttribute("hidden");
          } else {
            box.setAttribute("hidden","true");
          }
        ]]></setter>
      </property>
    </implementation>
  </binding>

</bindings>
