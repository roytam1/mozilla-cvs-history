#
# The contents of this file are subject to the Netscape Public
# License Version 1.1 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of
# the License at http://www.mozilla.org/NPL/
#
# Software distributed under the License is distributed on an "AS
# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
# implied. See the License for the specific language governing
# rights and limitations under the License.
#
# The Original Code is mozilla.org code.
#
# The Initial Developer of the Original Code is Netscape
# Communications Corporation.  Portions created by Netscape are
# Copyright (C) 1998 Netscape Communications Corporation. All
# Rights Reserved.
#
# Contributor(s): 
#  Brian Ryner <bryner@netscape.com>
# 

DEPTH		= ../..
topsrcdir	= @top_srcdir@
srcdir		= @srcdir@
VPATH		= @srcdir@

include $(DEPTH)/config/autoconf.mk

ifndef MOZ_NSS_AUTOCONF

ifeq (,$(filter-out OS2 WINNT,$(OS_ARCH)))
LOADABLE_ROOT_MODULE = nssckbi$(DLL_SUFFIX)
else
LOADABLE_ROOT_MODULE = libnssckbi$(DLL_SUFFIX)
endif
FREEBL_PURE32_MODULE = libfreebl_pure32_3$(DLL_SUFFIX)
FREEBL_HYBRID_MODULE = libfreebl_hybrid_3$(DLL_SUFFIX)

# NSS makefiles are not safe for parallel execution.
DEFAULT_GMAKE_FLAGS = MAKE="$(MAKE) -j1" -j1
DEFAULT_GMAKE_FLAGS += MOZILLA_INCLUDES="-I$(MOZ_BUILD_ROOT)/dist/include -I$(MOZ_BUILD_ROOT)/dist/include/nspr"
DEFAULT_GMAKE_FLAGS += SOURCE_MD_DIR=$(MOZ_BUILD_ROOT)/dist
DEFAULT_GMAKE_FLAGS += DIST=$(MOZ_BUILD_ROOT)/dist
DEFAULT_GMAKE_FLAGS += MOZILLA_CLIENT=1
DEFAULT_GMAKE_FLAGS += NO_MDUPDATE=1
ifndef MOZ_DEBUG
DEFAULT_GMAKE_FLAGS += BUILD_OPT=1
endif
ifdef GNU_CC
DEFAULT_GMAKE_FLAGS += NS_USE_GCC=1 NS_USE_NATIVE=
else
DEFAULT_GMAKE_FLAGS += NS_USE_GCC= NS_USE_NATIVE=1
endif
ifdef USE_N32
# It is not really necessary to specify USE_PTHREADS=1.  USE_PTHREADS
# merely adds _PTH to coreconf's OBJDIR name.
DEFAULT_GMAKE_FLAGS += USE_N32=1 USE_PTHREADS=1
endif
# coreconf also uses USE_64.

SUBMAKEFILES = ssl/Makefile pki/Makefile
else
DIRS		= ssl pki
endif

include $(topsrcdir)/config/rules.mk

ifndef MOZ_NSS_AUTOCONF
ABS_topsrcdir   := $(shell cd $(topsrcdir); pwd)

depend dependclean export::
	$(MAKE) -C ssl $@
	$(MAKE) -C pki $@

install::
ifneq ($(ABS_topsrcdir),$(MOZ_BUILD_ROOT))
	if test ! -d $(MOZ_BUILD_ROOT)/security/nss; then                   \
		cp -r $(topsrcdir)/security/nss $(MOZ_BUILD_ROOT)/security; \
	fi;
	if test ! -d $(MOZ_BUILD_ROOT)/security/coreconf; then              \
		cp -r $(topsrcdir)/security/coreconf $(MOZ_BUILD_ROOT)/security; \
	fi;
endif
	cd $(MOZ_BUILD_ROOT)/security/coreconf; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	cd $(DIST)/lib; cp -f libmozdbm_s.$(LIB_SUFFIX) libdbm.$(LIB_SUFFIX)
	cd $(MOZ_BUILD_ROOT)/security/nss/lib; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	$(INSTALL) -m 755 $(DIST)/lib/$(LOADABLE_ROOT_MODULE) $(DIST)/bin
ifneq (,$(filter SunOS HP-UX,$(OS_ARCH)))
ifneq ($(OS_TEST),i86pc)
	$(INSTALL) -m 755 $(DIST)/lib/$(FREEBL_PURE32_MODULE) $(DIST)/bin
	$(INSTALL) -m 755 $(DIST)/lib/$(FREEBL_HYBRID_MODULE) $(DIST)/bin
endif
endif
	$(MAKE) -C ssl $@
	$(MAKE) -C pki $@

clean clobber clobber_all realclean distclean::
	$(MAKE) -C ssl $@
	$(MAKE) -C pki $@
ifeq ($(ABS_topsrcdir),$(MOZ_BUILD_ROOT))
	cd $(MOZ_BUILD_ROOT)/security/coreconf; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
	cd $(MOZ_BUILD_ROOT)/security/nss; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
else
	if test -d $(MOZ_BUILD_ROOT)/security/nss; then \
		rm -rf $(MOZ_BUILD_ROOT)/security/nss;  \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/security/coreconf; then    \
		rm -rf $(MOZ_BUILD_ROOT)/security/coreconf;     \
	fi;
endif

endif # MOZ_NSS_AUTOCONF
